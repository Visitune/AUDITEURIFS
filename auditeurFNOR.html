<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Hub - Gestion des Auditeurs</title>
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary-color: #002d5a; /* Bleu marine FoodChain ID */
            --secondary-color: #00a99d; /* Vert turquoise FoodChain ID */
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --text-color: #333333;
            --text-light: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --border-color: #dee2e6;
            --shadow: 0 2px 4px rgba(0,0,0,0.07);
            --border-radius: 6px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Lato:wght@400;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Lato', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }

        /* --- LAYOUT & HEADER --- */
        .container { max-width: 1600px; margin: 0 auto; padding: 24px; }
        header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        .header-logo img { max-width: 200px; height: auto; }
        .header-title { text-align: right; }
        .header-title h1 { font-family: 'Montserrat', sans-serif; font-size: 2.2rem; font-weight: 700; color: var(--primary-color); }
        .header-title p { font-size: 1.1rem; color: var(--text-light); }
        .actions-bar { display: flex; justify-content: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: 1px solid transparent; border-radius: 4px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #001f3d; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #00877e; }
        #json-upload-label { background-color: var(--surface-color); color: var(--primary-color); border-color: var(--primary-color); }
        #json-upload-label:hover { background-color: #eef3f8; }
        input[type="file"] { display: none; }

        /* --- MAIN CONTENT GRID --- */
        main { display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
        #filters-panel { background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; height: fit-content; }
        .filter-group { margin-bottom: 22px; }
        .filter-group label.group-title { font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 1rem; display: block; margin-bottom: 12px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 8px; color: var(--primary-color); }
        .filter-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; }
        .checkbox-group label, .radio-group label { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 0.95rem; }
        .checkbox-group input, .radio-group input { margin-right: 10px; accent-color: var(--primary-color); }

        /* --- RESULTS & CARDS --- */
        #results-summary { margin-bottom: 16px; font-size: 1.1rem; color: var(--text-light); font-weight: 700; }
        #auditor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .auditor-card { background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; display: flex; flex-direction: column; position: relative; transition: all 0.2s; }
        .auditor-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-header { padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .auditor-name { font-family: 'Montserrat', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--primary-color); }
        .auditor-status { font-size: 0.9rem; color: var(--text-light); font-style: italic; }
        .card-section { margin-bottom: 16px; }
        .card-section h4 { font-family: 'Montserrat', sans-serif; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: var(--primary-color); }
        .qualif-toggle { font-weight: 700; background-color: #e6eaf0; color: var(--primary-color); padding: 4px 10px; border-radius: 16px; font-size: 0.8rem; cursor: pointer; display: inline-block; margin: 2px; }
        .qualif-toggle:hover { background-color: #d1dae6; }
        .qualif-toggle .auditor-id { font-weight: normal; color: var(--text-light); }
        .scopes-details { display: none; background-color: #f8f9fa; border-left: 3px solid var(--secondary-color); padding: 10px; margin-top: 8px; font-size: 0.85rem; }
        .scopes-details p { margin: 0 0 5px 0; }
        .no-results { grid-column: 1 / -1; text-align: center; padding: 40px; background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .comment-text { font-style: italic; font-size: 0.9rem; color: var(--text-light); }
        
        /* --- ALERTS & SUIVI --- */
        .suivi-item { display: grid; grid-template-columns: 1fr auto; align-items: center; font-size: 0.9rem; margin-bottom: 6px; padding: 4px; border-radius: 4px; }
        .suivi-item:nth-child(odd) { background-color: #f8f9fa; }
        .suivi-item .label { color: var(--text-light); }
        .suivi-item .value { font-weight: 700; text-align: right; }
        .value.ok { color: #28a745; }
        .value.soon { color: var(--warning-color); }
        .value.due { color: var(--danger-color); }
        .value.planned { color: var(--primary-color); font-style: italic; }
        .file-list-item a { text-decoration: none; color: var(--primary-color); }
        .file-list-item a:hover { text-decoration: underline; color: var(--secondary-color); }

        /* --- CARD ACTIONS --- */
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
        .auditor-card:hover .card-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: grid; place-items: center; }
        .action-btn:hover { background-color: #f1f3f4; }
        .action-btn svg { width: 20px; height: 20px; fill: var(--text-light); }

        /* --- FAB --- */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 1000; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1999; display: none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: var(--border-radius); z-index: 2000; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;}
        .modal-header h2 { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; color: var(--primary-color); }
        #close-modal { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-light); }
        #auditor-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 5px; font-weight: 700; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; }
        .form-group textarea { min-height: 60px; }
        .form-group input:disabled { background-color: #e9ecef; }
        .modal-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; }
        .fieldset { border: 1px solid var(--border-color); border-radius: 4px; padding: 15px; margin-top: 10px; }
        .fieldset legend { font-family: 'Montserrat', sans-serif; font-weight: 600; padding: 0 10px; color: var(--primary-color); }
        .qualif-edit-block { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .qualif-edit-block .form-group { margin-top: 10px; }
        #modal-file-list button { background: var(--danger-color); color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 8px;}

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { header { flex-direction: column; text-align: center; } .header-title { text-align: center; } }
        @media (max-width: 600px) { #auditor-form { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-logo">
                <a href="https://www.visipilot.com/"><img src="https://visipilot.com/wp-content/uploads/2020/04/logovisipilot-300x81-1.png" alt="FoodChain ID Logo"></a>
            </div>
            <div class="header-title">
                <h1>Auditor Hub</h1>
                <p>Chargez, gérez et sauvegardez les données de vos auditeurs</p>
            </div>
        </header>

        <div class="actions-bar">
            <label for="json-upload" class="btn" id="json-upload-label">Charger un Package</label>
            <input type="file" id="json-upload" accept=".json">
            <button id="save-json-btn" class="btn btn-secondary">Exporter le Package</button>
        </div>

        <main>
            <aside id="filters-panel">
                 <div class="filter-group">
                    <label for="name-filter" class="group-title">Nom de l'auditeur</label>
                    <input type="text" id="name-filter" placeholder="Rechercher par nom...">
                </div>
                <div class="filter-group">
                    <label class="group-title">Alertes de suivi</label>
                    <div class="checkbox-group" id="alert-filter">
                        <label><input type="checkbox" name="alert" value="calibration_due"> Calibration due</label>
                        <label><input type="checkbox" name="alert" value="witness_due"> Witness du</label>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="group-title">Référentiels</label>
                    <div class="checkbox-group" id="referentiel-filter"></div>
                </div>
                <div class="filter-group">
                    <label for="food-sectors-filter" class="group-title">Secteurs IFS Food</label>
                    <input type="text" id="food-sectors-filter" placeholder="Ex: 1, 5, 8">
                </div>
                 <div class="filter-group">
                    <label class="group-title">Statut</label>
                    <div class="radio-group" id="status-filter">
                        <label><input type="radio" name="status" value="all" checked> Tous</label>
                        <label><input type="radio" name="status" value="Auditeur Exclusif"> Exclusif</label>
                        <label><input type="radio" name="status" value="Auditeur Non Exclusif"> Non Exclusif</label>
                    </div>
                </div>
            </aside>

            <section id="results-panel">
                <div id="results-summary"></div>
                <div id="auditor-grid"></div>
            </section>
        </main>
    </div>

    <button id="add-auditor-btn" class="fab">+</button>
    <div class="modal-overlay" id="auditor-modal-overlay">
        <div class="modal"><div class="modal-header"><h2 id="modal-title"></h2><button id="close-modal">&times;</button></div><form id="auditor-form"></form></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let auditorsData = [
          {
            "initiale": "MMA", "nom_auditeur": "Mounir MAHJOUB", "exclusivite": "Auditeur Exclusif", "id_ifs": 302,
            "qualifications": {
              "ifs_food": { "qualifie": true, "secteurs_produits": ["1","2","4","5","6","7","8","9","10","11"], "secteurs_technologiques": ["A","B","C","D","E","F"]},
              "ifs_logistics": { "qualifie": true, "scopes_v3": ["1","1.1","1.2","1.3","1.4","1.5","1.6","1.7","1.8","1.9","1.10","1.11","2","2.1","2.2","2.3","2.4","3","3.1","3.2","3.3","3.4","3.5","3.6","3.7","4","4.1","4.2","4.3","4.4","4.5","4.6","4.7","4.8","4.9","4.10","4.11","4.12"]},
              "ifs_broker": { "qualifie": true, "scopes": ["1.1","1.2","1.3","1.4","1.5","1.6","1.7","1.8","1.9","1.10","1.11"]},
              "brcgs": { "qualifie": true, "universal_auditor_number": 21265, "categories": ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"]}
            }, "commentaires_generaux": null
          },
          {
            "initiale": "MKN", "nom_auditeur": "Mehdi KNANI", "exclusivite": "Auditeur Exclusif", "id_ifs": 2018,
            "qualifications": {
              "ifs_food": { "qualifie": true, "secteurs_produits": ["2","4","5","6","7","8","9"], "secteurs_technologiques": ["A","B","C","D","E","F"]},
              "ifs_logistics": { "qualifie": false, "scopes_v3": [] },
              "ifs_broker": { "qualifie": false, "scopes": [] },
              "brcgs": { "qualifie": true, "universal_auditor_number": 21433, "categories": ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","17","18"]}
            }, "commentaires_generaux": "Ne souhaite pas faire d'audit dans le secteur 8 (vin)"
          },
          {
            "initiale": "RCH", "nom_auditeur": "Rihab CHABBOUH", "exclusivite": "Auditeur Exclusif", "id_ifs": 2983,
            "qualifications": {
              "ifs_food": { "qualifie": true, "secteurs_produits": ["1","2","4","5","6","7","8","11"], "secteurs_technologiques": ["A","B","C","D","E","F"]},
              "ifs_logistics": { "qualifie": false, "scopes_v3": [] },
              "ifs_broker": { "qualifie": true, "scopes": ["1.1","1.2","1.3","1.4","1.5","1.6","1.7","1.8","1.9","1.10","1.11"]},
              "brcgs": { "qualifie": true, "universal_auditor_number": 21256, "categories": ["3","4","5","6","7","8","9","10","11","13","14","15","16","18"]}
            }, "commentaires_generaux": null
          },
          {
            "initiale": "KMO", "nom_auditeur": "Karim MOKDAD", "exclusivite": "Auditeur Exclusif", "id_ifs": 3680,
            "qualifications": {
              "ifs_food": { "qualifie": true, "secteurs_produits": ["4","5","6","7","8","9","10"], "secteurs_technologiques": ["B","C","D","E","F"]},
              "ifs_logistics": { "qualifie": false, "scopes_v3": [] },
              "ifs_broker": { "qualifie": false, "scopes": [] },
              "brcgs": { "qualifie": true, "universal_auditor_number": 24604, "categories": ["3","5","6","7","8","10","11","12","13","14","15","16","17","18"]}
            }, "commentaires_generaux": null
          }
        ];
        
        let tempFiles = [];

        const auditorGrid = document.getElementById('auditor-grid');
        const resultsSummary = document.getElementById('results-summary');
        const nameFilter = document.getElementById('name-filter');
        const alertFilterContainer = document.getElementById('alert-filter');
        const referentielFilterContainer = document.getElementById('referentiel-filter');
        const foodSectorsFilter = document.getElementById('food-sectors-filter');
        const statusFilter = document.getElementById('status-filter');
        const jsonUpload = document.getElementById('json-upload');
        const saveJsonBtn = document.getElementById('save-json-btn');
        const addAuditorBtn = document.getElementById('add-auditor-btn');
        const modalOverlay = document.getElementById('auditor-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const auditorForm = document.getElementById('auditor-form');
        const closeModalBtn = document.getElementById('close-modal');

        const saveToLocalStorage = () => {
            try { localStorage.setItem('auditorHubData', JSON.stringify(auditorsData)); }
            catch (error) { console.error("Erreur localStorage:", error); alert("Erreur: Impossible de sauvegarder. Fichiers trop volumineux."); }
        };

        const loadFromLocalStorage = () => {
            const data = localStorage.getItem('auditorHubData');
            if (data) { auditorsData = JSON.parse(data); return true; }
            return false;
        };

        const loadData = (data) => {
            auditorsData = JSON.parse(JSON.stringify(data));
            setupDynamicFilters();
            filterAndRender();
            saveToLocalStorage();
        };

        jsonUpload.addEventListener('change', (event) => {
            if (auditorsData.length > 0 && !confirm("Attention, charger un nouveau fichier écrasera les données actuelles. Continuer ?")) { event.target.value = ''; return; }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try { loadData(JSON.parse(e.target.result)); alert('Package chargé avec succès !'); }
                catch (error) { alert('Erreur: Le fichier JSON est invalide.'); }
                finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        });

        saveJsonBtn.addEventListener('click', () => {
            if (auditorsData.length === 0) { alert('Aucune donnée à exporter.'); return; }
            const jsonString = JSON.stringify(auditorsData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'auditor_hub_package.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        const setupDynamicFilters = () => {
            referentielFilterContainer.innerHTML = '';
            const referentiels = [
                { id: 'ifs_food', name: 'IFS Food' }, { id: 'ifs_logistics', name: 'IFS Logistics' },
                { id: 'ifs_broker', name: 'IFS Broker' }, { id: 'brcgs', name: 'BRCGS' }
            ];
            referentiels.forEach(ref => { referentielFilterContainer.innerHTML += `<label><input type="checkbox" name="referentiel" value="${ref.id}">${ref.name}</label>`; });
            document.querySelectorAll('#referentiel-filter input').forEach(el => el.addEventListener('change', filterAndRender));
        };

        const getAlertStatus = (dateString, years) => {
            if (!dateString) return { status: 'N/A', nextDate: null };
            const lastDate = new Date(dateString);
            if (isNaN(lastDate.getTime())) return { status: 'N/A', nextDate: null };
            const nextDate = new Date(lastDate.getFullYear() + years, lastDate.getMonth(), lastDate.getDate());
            const today = new Date(); today.setHours(0,0,0,0);
            const threeMonthsFromNow = new Date(); threeMonthsFromNow.setMonth(today.getMonth() + 3);
            let status = 'ok';
            if (nextDate < today) status = 'due';
            else if (nextDate < threeMonthsFromNow) status = 'soon';
            return { status, nextDate };
        };
        
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString();
        }

        const createScopesHTML = (auditorId, qualifKey, qualifData, scopeMappings, idInfo = '') => {
            if (!qualifData?.qualifie) return '';
            const scopesId = `scopes-${auditorId}-${qualifKey}`;
            let detailsHTML = '';
            scopeMappings.forEach(mapping => {
                const scopes = qualifData[mapping.key];
                if (scopes && scopes.length > 0) {
                    detailsHTML += `<p><strong>${mapping.label}:</strong> ${scopes.join(', ')}</p>`;
                }
            });

            let titleHTML = scopeMappings[0].title;
            if (idInfo) {
                titleHTML += ` <span class="auditor-id">${idInfo}</span>`;
            }
            return `<span class="qualif-toggle" data-target="${scopesId}">${titleHTML}</span>
                    <div class="scopes-details" id="${scopesId}">${detailsHTML || '<p>Aucun scope défini.</p>'}</div>`;
        };


        const renderAuditors = (auditors) => {
            auditorGrid.innerHTML = '';
            resultsSummary.textContent = `${auditors.length} auditeur(s) trouvé(s)`;
            if (auditors.length === 0) { auditorGrid.innerHTML = '<div class="no-results"><h3>Aucun auditeur trouvé</h3><p>Chargez un package ou ajustez vos filtres.</p></div>'; return; }

            auditors.forEach(auditor => {
                let qualifsHTML = '';
                const ifsIdInfo = auditor.id_ifs ? `(ID: ${auditor.id_ifs})` : '';
                const brcgsIdInfo = auditor.qualifications.brcgs?.universal_auditor_number ? `(UAN: ${auditor.qualifications.brcgs.universal_auditor_number})` : '';

                qualifsHTML += createScopesHTML(auditor.initiale, 'ifs_food', auditor.qualifications.ifs_food, [{title: 'IFS Food', label: 'Secteurs Produits', key: 'secteurs_produits'}, {title: 'IFS Food', label: 'Secteurs Tech.', key: 'secteurs_technologiques'}], ifsIdInfo);
                qualifsHTML += createScopesHTML(auditor.initiale, 'ifs_logistics', auditor.qualifications.ifs_logistics, [{title: 'IFS Logistics', label: 'Scopes', key: 'scopes_v3'}]);
                qualifsHTML += createScopesHTML(auditor.initiale, 'ifs_broker', auditor.qualifications.ifs_broker, [{title: 'IFS Broker', label: 'Scopes', key: 'scopes'}]);
                qualifsHTML += createScopesHTML(auditor.initiale, 'brcgs', auditor.qualifications.brcgs, [{title: 'BRCGS', label: 'Catégories', key: 'categories'}], brcgsIdInfo);

                const cal = getAlertStatus(auditor.suivi?.derniere_calibration, 2);
                const wit = getAlertStatus(auditor.suivi?.dernier_witness, 2);
                const filesHTML = (auditor.fichiers || []).map(file => `<div><a href="${file.data}" download="${file.nom}">${file.nom}</a></div>`).join('');

                const card = document.createElement('div');
                card.className = 'auditor-card';
                card.innerHTML = `
                    <div class="card-actions">
                        <button class="action-btn edit-btn" title="Modifier"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                        <button class="action-btn delete-btn" title="Supprimer"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                    </div>
                    <div class="card-header"><div class="auditor-name">${auditor.nom_auditeur} (${auditor.initiale})</div><div class="auditor-status">${auditor.exclusivite}</div></div>
                    <div class="card-section"><h4>Qualifications</h4><div>${qualifsHTML || 'Aucune'}</div></div>
                    ${auditor.commentaires_generaux ? `<div class="card-section"><h4>Commentaire</h4><p class="comment-text">${auditor.commentaires_generaux}</p></div>` : ''}
                    <div class="card-section"><h4>Suivi</h4>
                        <div class="suivi-item"><span class="label">Proch. cal. due (2 ans):</span> <span class="value ${cal.status}">${cal.nextDate?.toLocaleDateString() || 'N/A'}</span></div>
                        <div class="suivi-item"><span class="label">Proch. wit. du (2 ans):</span> <span class="value ${wit.status}">${wit.nextDate?.toLocaleDateString() || 'N/A'}</span></div>
                        <div class="suivi-item"><span class="label">Proch. cal. planifiée:</span> <span class="value planned">${formatDate(auditor.suivi?.prochaine_calibration_planifiee)}</span></div>
                        <div class="suivi-item"><span class="label">Proch. wit. planifié:</span> <span class="value planned">${formatDate(auditor.suivi?.prochain_witness_planifie)}</span></div>
                    </div>
                    ${filesHTML ? `<div class="card-section"><h4>Fichiers</h4>${filesHTML}</div>` : ''}`;
                
                card.querySelector('.edit-btn').addEventListener('click', () => openModal(auditor));
                card.querySelector('.delete-btn').addEventListener('click', () => deleteAuditor(auditor.initiale));
                auditorGrid.appendChild(card);
            });
        };

        auditorGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('qualif-toggle')) {
                const targetId = e.target.dataset.target;
                const detailsEl = document.getElementById(targetId);
                if (detailsEl) { detailsEl.style.display = detailsEl.style.display === 'block' ? 'none' : 'block'; }
            }
        });

        const filterAndRender = () => {
            const nameQuery = nameFilter.value.toLowerCase();
            const foodSectorsQuery = foodSectorsFilter.value.split(',').map(s => s.trim()).filter(Boolean);
            const statusQuery = statusFilter.querySelector('input:checked').value;
            const selectedReferentiels = [...referentielFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value);
            const selectedAlerts = [...alertFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value);
            
            const filteredAuditors = auditorsData.filter(auditor => {
                if (nameQuery && !auditor.nom_auditeur.toLowerCase().includes(nameQuery)) return false;
                if (statusQuery !== 'all' && auditor.exclusivite !== statusQuery) return false;
                if (selectedReferentiels.length > 0 && !selectedReferentiels.every(ref => auditor.qualifications[ref]?.qualifie)) return false;
                if (foodSectorsQuery.length > 0 && (!auditor.qualifications.ifs_food?.qualifie || !foodSectorsQuery.every(req => auditor.qualifications.ifs_food.secteurs_produits?.includes(req)))) return false;
                if (selectedAlerts.length > 0) {
                    const calStatus = getAlertStatus(auditor.suivi?.derniere_calibration, 2).status;
                    const witStatus = getAlertStatus(auditor.suivi?.dernier_witness, 2).status;
                    if (!((selectedAlerts.includes('calibration_due') && ['due', 'soon'].includes(calStatus)) || (selectedAlerts.includes('witness_due') && ['due', 'soon'].includes(witStatus)))) return false;
                }
                return true;
            });
            renderAuditors(filteredAuditors);
        };

        const deleteAuditor = (initiale) => {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'auditeur ${initiale} ?`)) {
                auditorsData = auditorsData.filter(a => a.initiale !== initiale);
                saveToLocalStorage();
                filterAndRender();
            }
        };

        const openModal = (auditor = null) => {
            const isEditing = auditor !== null;
            modalTitle.textContent = isEditing ? `Modifier l'Auditeur` : 'Ajouter un Auditeur';
            const data = isEditing ? auditor : { initiale: '', nom_auditeur: '', exclusivite: 'Auditeur Exclusif', suivi: {}, qualifications: {}, fichiers: [] };
            tempFiles = [...(data.fichiers || [])];

            auditorForm.innerHTML = `
                <input type="hidden" id="form-mode" value="${isEditing ? data.initiale : 'new'}">
                <div class="form-group"><label for="initiale">Initiales</label><input type="text" id="initiale" value="${data.initiale || ''}" ${isEditing ? 'disabled' : ''} required></div>
                <div class="form-group"><label for="nom_auditeur">Nom Complet</label><input type="text" id="nom_auditeur" value="${data.nom_auditeur || ''}" required></div>
                <div class="form-group full-width"><label for="commentaires_generaux">Commentaire général</label><textarea id="commentaires_generaux">${data.commentaires_generaux || ''}</textarea></div>
                
                <fieldset class="full-width"><legend>Qualifications & Scopes</legend>
                    <!-- IFS FOOD -->
                    <div class="qualif-edit-block">
                        <label><input type="checkbox" id="ifs_food_qualifie" data-targets="ifs_food_secteurs_produits,ifs_food_secteurs_technologiques,id_ifs" ${data.qualifications?.ifs_food?.qualifie ? 'checked' : ''}> <strong>Qualifié IFS Food</strong></label>
                        <div class="form-group"><label for="id_ifs">ID IFS</label><input type="number" id="id_ifs" value="${data.id_ifs || ''}"></div>
                        <div class="form-group"><label for="ifs_food_secteurs_produits">Secteurs Produits (séparés par virgule)</label><input type="text" id="ifs_food_secteurs_produits" value="${data.qualifications?.ifs_food?.secteurs_produits?.join(', ') || ''}"></div>
                        <div class="form-group"><label for="ifs_food_secteurs_technologiques">Secteurs Technologiques (séparés par virgule)</label><input type="text" id="ifs_food_secteurs_technologiques" value="${data.qualifications?.ifs_food?.secteurs_technologiques?.join(', ') || ''}"></div>
                    </div>
                    <!-- IFS LOGISTICS -->
                    <div class="qualif-edit-block">
                         <label><input type="checkbox" id="ifs_logistics_qualifie" data-targets="ifs_logistics_scopes_v3" ${data.qualifications?.ifs_logistics?.qualifie ? 'checked' : ''}> <strong>Qualifié IFS Logistics</strong></label>
                        <div class="form-group"><label for="ifs_logistics_scopes_v3">Scopes v3 (séparés par virgule)</label><input type="text" id="ifs_logistics_scopes_v3" value="${data.qualifications?.ifs_logistics?.scopes_v3?.join(', ') || ''}"></div>
                    </div>
                    <!-- IFS BROKER -->
                    <div class="qualif-edit-block">
                         <label><input type="checkbox" id="ifs_broker_qualifie" data-targets="ifs_broker_scopes" ${data.qualifications?.ifs_broker?.qualifie ? 'checked' : ''}> <strong>Qualifié IFS Broker</strong></label>
                        <div class="form-group"><label for="ifs_broker_scopes">Scopes (séparés par virgule)</label><input type="text" id="ifs_broker_scopes" value="${data.qualifications?.ifs_broker?.scopes?.join(', ') || ''}"></div>
                    </div>
                    <!-- BRCGS -->
                    <div class="qualif-edit-block">
                         <label><input type="checkbox" id="brcgs_qualifie" data-targets="brcgs_categories,brcgs_uan" ${data.qualifications?.brcgs?.qualifie ? 'checked' : ''}> <strong>Qualifié BRCGS</strong></label>
                        <div class="form-group"><label for="brcgs_uan">Universal Auditor Number (UAN)</label><input type="number" id="brcgs_uan" value="${data.qualifications?.brcgs?.universal_auditor_number || ''}"></div>
                        <div class="form-group"><label for="brcgs_categories">Catégories (séparées par virgule)</label><input type="text" id="brcgs_categories" value="${data.qualifications?.brcgs?.categories?.join(', ') || ''}"></div>
                    </div>
                </fieldset>
                
                <fieldset class="full-width"><legend>Suivi des Compétences</legend>
                    <div class="form-group"><label for="derniere_calibration">Dernière calibration</label><input type="date" id="derniere_calibration" value="${data.suivi?.derniere_calibration || ''}"></div>
                    <div class="form-group"><label for="dernier_witness">Dernier witness</label><input type="date" id="dernier_witness" value="${data.suivi?.dernier_witness || ''}"></div>
                    <div class="form-group"><label for="prochaine_calibration_planifiee">Prochaine calibration planifiée</label><input type="date" id="prochaine_calibration_planifiee" value="${data.suivi?.prochaine_calibration_planifiee || ''}"></div>
                    <div class="form-group"><label for="prochain_witness_planifie">Prochain witness planifié</label><input type="date" id="prochain_witness_planifie" value="${data.suivi?.prochain_witness_planifie || ''}"></div>
                </fieldset>
                
                <fieldset class="full-width"><legend>Fichiers Joints</legend><div id="modal-file-list"></div><div class="form-group" style="margin-top:10px;"><label for="file-upload" class="btn">Ajouter</label><input type="file" id="file-upload" multiple></div></fieldset>
                <div class="modal-actions"><button type="button" class="btn" id="cancel-form">Annuler</button><button type="submit" class="btn btn-primary">Sauvegarder</button></div>`;
            
            updateModalFileList();
            document.getElementById('file-upload').addEventListener('change', handleFileSelect);
            document.getElementById('cancel-form').addEventListener('click', closeModal);

            auditorForm.querySelectorAll('input[type="checkbox"][data-targets]').forEach(cb => {
                const toggleTargets = () => {
                    const targets = cb.dataset.targets.split(',');
                    targets.forEach(targetId => { document.getElementById(targetId).disabled = !cb.checked; });
                };
                cb.addEventListener('change', toggleTargets);
                toggleTargets(); // Initial state
            });
            modalOverlay.style.display = 'block';
        };

        const handleFileSelect = (event) => {
            Promise.all([...event.target.files].map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ nom: file.name, type: file.type, size: file.size, data: reader.result });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }))).then(newFiles => { tempFiles.push(...newFiles); updateModalFileList(); })
            .catch(error => alert("Un fichier n'a pas pu être lu."));
            event.target.value = '';
        };

        const updateModalFileList = () => {
            const listEl = document.getElementById('modal-file-list');
            listEl.innerHTML = tempFiles.map((file, index) => `<div>${file.nom} <button type="button" data-index="${index}">X</button></div>`).join('') || 'Aucun fichier.';
            listEl.querySelectorAll('button').forEach(btn => btn.addEventListener('click', (e) => { tempFiles.splice(e.target.dataset.index, 1); updateModalFileList(); }));
        };
        
        const closeModal = () => modalOverlay.style.display = 'none';

        auditorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mode = document.getElementById('form-mode').value;
            const index = mode === 'new' ? -1 : auditorsData.findIndex(a => a.initiale === mode);
            
            const getScopes = (id) => { const val = document.getElementById(id).value.trim(); return val ? val.split(',').map(s => s.trim()) : []; };
            
            let auditorToSave = index > -1 ? auditorsData[index] : { initiale: document.getElementById('initiale').value.toUpperCase(), qualifications: {}, suivi: {} };
            
            if (mode === 'new') {
                if (!auditorToSave.initiale) { alert("Erreur : Les initiales sont obligatoires."); return; }
                if (auditorsData.some(a => a.initiale === auditorToSave.initiale)) { alert("Erreur : Les initiales existent déjà."); return; }
            }

            auditorToSave.nom_auditeur = document.getElementById('nom_auditeur').value;
            auditorToSave.commentaires_generaux = document.getElementById('commentaires_generaux').value.trim() || null;
            auditorToSave.id_ifs = document.getElementById('id_ifs').value;
            auditorToSave.fichiers = [...tempFiles];
            auditorToSave.suivi = {
                derniere_calibration: document.getElementById('derniere_calibration').value,
                dernier_witness: document.getElementById('dernier_witness').value,
                prochaine_calibration_planifiee: document.getElementById('prochaine_calibration_planifiee').value,
                prochain_witness_planifie: document.getElementById('prochain_witness_planifie').value
            };
            
            auditorToSave.qualifications = {
                ifs_food: { qualifie: document.getElementById('ifs_food_qualifie').checked, secteurs_produits: getScopes('ifs_food_secteurs_produits'), secteurs_technologiques: getScopes('ifs_food_secteurs_technologiques') },
                ifs_logistics: { qualifie: document.getElementById('ifs_logistics_qualifie').checked, scopes_v3: getScopes('ifs_logistics_scopes_v3') },
                ifs_broker: { qualifie: document.getElementById('ifs_broker_qualifie').checked, scopes: getScopes('ifs_broker_scopes') },
                brcgs: { qualifie: document.getElementById('brcgs_qualifie').checked, categories: getScopes('brcgs_categories'), universal_auditor_number: document.getElementById('brcgs_uan').value }
            };
            
            if (mode === 'new') { auditorsData.push(auditorToSave); } 
            else { auditorsData[index] = auditorToSave; }

            saveToLocalStorage();
            closeModal();
            filterAndRender();
        });

        const allStaticFilters = [nameFilter, foodSectorsFilter, ...statusFilter.querySelectorAll('input'), ...alertFilterContainer.querySelectorAll('input')];
        allStaticFilters.forEach(el => { el.addEventListener('input', filterAndRender); el.addEventListener('change', filterAndRender); });
        addAuditorBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

        loadFromLocalStorage();
        setupDynamicFilters();
        filterAndRender();
    });
    </script>
</body>
</html>